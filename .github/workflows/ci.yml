name: 游댢 Ansible Network Automation CI

# Manual trigger only - no automatic runs on commits
on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'get_interfaces'
        type: choice
        options:
          - get_interfaces
          - configure_interfaces
          - both
      target_host:
        description: 'Target host (leave empty for all)'
        required: false
        type: string

jobs:
  setup:
    name: 游 Setup Environment
    runs-on: self-hosted
    
    steps:
      - name: 游닌 Checkout repository
        uses: actions/checkout@v4
      
      - name: 游냀 Create Python virtual environment
        run: |
          python3 -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip
          pip install -r week-02-automation-patterns/02-ansible/requirements.txt

  get_interfaces:
    name: 游니 Get Network Interfaces
    runs-on: self-hosted
    needs: setup
    if: ${{ github.event.inputs.action == 'get_interfaces' || github.event.inputs.action == 'both' }}
    
    steps:
      - name: 游닌 Checkout repository
        uses: actions/checkout@v4
      
      - name: 郊윒잺 Run Get Interfaces Playbook
        working-directory: week-02-automation-patterns/02-ansible
        env:
          ANSIBLE_HOST_KEY_CHECKING: 'False'
        run: |
          source ../../.venv/bin/activate
          if [ -n "${{ github.event.inputs.target_host }}" ]; then
            ansible-playbook get_interfaces.yml --limit "${{ github.event.inputs.target_host }}"
          else
            ansible-playbook get_interfaces.yml
          fi
      
      - name: 游닋 Upload Get Interfaces Output
        uses: actions/upload-artifact@v4
        with:
          name: get-interfaces-output-${{ github.run_number }}
          path: week-02-automation-patterns/02-ansible/output/
          retention-days: 90

  configure_interfaces:
    name: 丘뙖잺 Configure Network Interfaces
    runs-on: self-hosted
    needs: [setup, get_interfaces]
    if: |
      always() &&
      needs.setup.result == 'success' &&
      (needs.get_interfaces.result == 'success' || needs.get_interfaces.result == 'skipped') &&
      (github.event.inputs.action == 'configure_interfaces' || github.event.inputs.action == 'both')
    
    steps:
      - name: 游닌 Checkout repository
        uses: actions/checkout@v4
      
      - name: 郊윒잺 Run Configure Interfaces Playbook
        working-directory: week-02-automation-patterns/02-ansible
        env:
          ANSIBLE_HOST_KEY_CHECKING: 'False'
        run: |
          source ../../.venv/bin/activate
          if [ -n "${{ github.event.inputs.target_host }}" ]; then
            ansible-playbook configure_interfaces.yml --limit "${{ github.event.inputs.target_host }}"
          else
            ansible-playbook configure_interfaces.yml
          fi
      
      - name: 游닋 Upload Configure Interfaces Output
        uses: actions/upload-artifact@v4
        with:
          name: configure-interfaces-output-${{ github.run_number }}
          path: week-02-automation-patterns/02-ansible/output/
          retention-days: 90

  summary:
    name: 游늵 Workflow Summary
    runs-on: self-hosted
    needs: [setup, get_interfaces, configure_interfaces]
    if: always()
    
    steps:
      - name: 游닇 Generate Summary
        run: |
          echo "## Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Action**: ${{ github.event.inputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Target Host**: ${{ github.event.inputs.target_host || 'all' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Results" >> $GITHUB_STEP_SUMMARY
          echo "- Setup: ${{ needs.setup.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Get Interfaces: ${{ needs.get_interfaces.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Configure Interfaces: ${{ needs.configure_interfaces.result }}" >> $GITHUB_STEP_SUMMARY
