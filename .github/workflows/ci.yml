name: ğŸ”§ Ansible Network Automation CI

# Manual trigger only - no automatic runs on commits
on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'get_interfaces'
        type: choice
        options:
          - get_interfaces
          - configure_interfaces
          - both
      target_host:
        description: 'Target host (leave empty for all)'
        required: false
        type: string

jobs:
  setup:
    name: ğŸš€ Setup Environment
    runs-on: self-hosted
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ğŸ Create Python virtual environment
        run: |
          python3 -m venv week-02-automation-patterns/03-cicd/.venv
          source week-02-automation-patterns/03-cicd/.venv/bin/activate
          pip install --upgrade pip
          pip install -r week-02-automation-patterns/02-ansible/requirements.txt

  get_interfaces:
    name: ğŸ“¡ Get Network Interfaces
    runs-on: self-hosted
    needs: setup
    if: ${{ github.event.inputs.action == 'get_interfaces' || github.event.inputs.action == 'both' }}
    
    steps:      
      - name: â–¶ï¸ Run Get Interfaces Playbook
        working-directory: week-02-automation-patterns/02-ansible
        env:
          ANSIBLE_HOST_KEY_CHECKING: 'False'
        run: |
          source ../03-cicd/.venv/bin/activate
          if [ -n "${{ github.event.inputs.target_host }}" ]; then
            ansible-playbook get_interfaces.yml --limit "${{ github.event.inputs.target_host }}"
          else
            ansible-playbook get_interfaces.yml
          fi
      
      - name: ğŸ“¤ Upload Get Interfaces Output
        uses: actions/upload-artifact@v4
        with:
          name: get-interfaces-output-${{ github.run_number }}
          path: week-02-automation-patterns/02-ansible/output/
          retention-days: 90

  configure_interfaces:
    name: âš™ï¸ Configure Network Interfaces
    runs-on: self-hosted
    needs: [setup, get_interfaces]
    if: |
      always() &&
      needs.setup.result == 'success' &&
      (needs.get_interfaces.result == 'success' || needs.get_interfaces.result == 'skipped') &&
      (github.event.inputs.action == 'configure_interfaces' || github.event.inputs.action == 'both')
    
    steps:      
      - name: â–¶ï¸ Run Configure Interfaces Playbook
        working-directory: week-02-automation-patterns/02-ansible
        env:
          ANSIBLE_HOST_KEY_CHECKING: 'False'
        run: |
          source ../03-cicd/.venv/bin/activate
          if [ -n "${{ github.event.inputs.target_host }}" ]; then
            ansible-playbook configure_interfaces.yml --limit "${{ github.event.inputs.target_host }}"
          else
            ansible-playbook configure_interfaces.yml
          fi

  summary:
    name: ğŸ“Š Workflow Summary
    runs-on: self-hosted
    needs: [setup, get_interfaces, configure_interfaces]
    if: always()
    
    steps:
      - name: ğŸ“ Generate Summary
        run: |
          echo "## Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Action**: ${{ github.event.inputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Target Host**: ${{ github.event.inputs.target_host || 'all' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Results" >> $GITHUB_STEP_SUMMARY
          echo "- Setup: ${{ needs.setup.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Get Interfaces: ${{ needs.get_interfaces.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Configure Interfaces: ${{ needs.configure_interfaces.result }}" >> $GITHUB_STEP_SUMMARY

  cleanup:
    name: ğŸ§¹ Cleanup Environment
    runs-on: self-hosted
    needs: [setup, get_interfaces, configure_interfaces, summary]
    if: always()
    
    steps:
      - name: ğŸ—‘ï¸ Remove virtual environment
        run: |
          if [ -d week-02-automation-patterns/03-cicd/.venv ]; then
            rm -rf week-02-automation-patterns/03-cicd/.venv
            echo "Virtual environment removed successfully"
          else
            echo "No virtual environment found to remove"
          fi
